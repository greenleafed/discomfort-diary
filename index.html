<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¶ˆí¸ì¼ê¸° - í´ë¼ìš°ë“œ ë™ê¸°í™”</title>
    <style>
        :root { --bg: #f8f9fa; --primary: #343a40; --secondary: #6c757d; --card: #ffffff; --danger: #ffadad; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { font-size: 1.5rem; margin-bottom: 20px; letter-spacing: -1px; text-align: center; }
        
        #noteInput { 
            width: 100%; border: 2px solid #ddd; border-radius: 12px; padding: 15px;
            font-size: 16px; box-sizing: border-box; outline: none; transition: border 0.3s; resize: none;
        }
        #noteInput:focus { border-color: var(--primary); }
        #noteInput:disabled { background: #eee; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn-main { flex: 3; background: var(--primary); color: white; padding: 15px; }
        .btn-sub { flex: 1; background: var(--secondary); color: white; padding: 15px; font-size: 0.8rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #diaryList { margin-top: 30px; }
        .note-item { 
            position: relative; background: var(--card); padding: 15px; border-radius: 12px; 
            margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .time { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .text { line-height: 1.5; padding-right: 10px; word-break: break-all; }
        .loading-spinner { text-align: center; color: var(--secondary); margin-top: 20px; font-size: 0.9rem; }
	.delete-btn {
        	position: absolute; top: 12px; right: 12px;
        	background: none; border: none; color: var(--danger);
        	font-size: 1.4rem; cursor: pointer; padding: 5px; line-height: 1;
    	}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ ë¶ˆí¸ì¼ê¸°</h1>
    <textarea id="noteInput" rows="4" placeholder="ì§€ê¸ˆ ì–´ë–¤ ì ì´ ë¶ˆí¸í•œê°€ìš”? (ì €ì¥ ì‹œ 1~2ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤)"></textarea>
    <div class="btn-group">
        <button id="saveBtn" class="btn-main" style="flex: 1;" onclick="saveNote()">ë¶ˆí¸ ê¸°ë¡í•˜ê¸°</button>
    </div>
    <div id="diaryList"></div>
</div>

<script>
    // ë³¸ì¸ì˜ API URL
    const API_URL = "https://script.google.com/macros/s/AKfycbysFhu0i3QZIvqQWYRfSSwK_53xZ_mjST1HJ5CADNwf81gNE5OoaaJRXMSKYVlZUXU/exec";

    window.onload = () => displayNotes();

    // 1. ë°ì´í„° ì €ì¥ (POST)
    async function saveNote() {
        const input = document.getElementById('noteInput');
        const btn = document.getElementById('saveBtn');
        if (!input.value.trim()) return;

        const newNote = {
            id: Date.now(),
            content: input.value,
            date: new Date().toLocaleString()
        };

        input.disabled = true;
        btn.disabled = true;
        btn.innerText = "ë™ê¸°í™” ì¤‘...";

        try {
            // êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë°ì´í„° ì „ì†¡
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(newNote)
            });
            input.value = '';
        } catch (e) {
            console.error(e);
            alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } finally {
            input.disabled = false;
            btn.disabled = false;
            btn.innerText = "ë¶ˆí¸ ê¸°ë¡í•˜ê¸°";
            displayNotes(); // ì „ì†¡ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
    }

    // 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (GET)
	async function displayNotes() {
        const list = document.getElementById('diaryList');
        list.innerHTML = '<div class="loading-spinner">êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        try {
            const response = await fetch(API_URL);
            const notes = await response.json();
            
            // ìµœì‹ ìˆœ ì •ë ¬ (ID ê¸°ì¤€)
            notes.sort((a, b) => b.id - a.id);

            if (notes.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888; margin-top:40px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // [í•µì‹¬ ë¶€ë¶„] map í•¨ìˆ˜ ì•ˆì—ì„œ ì‚­ì œ ë²„íŠ¼(<button class="delete-btn">)ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            list.innerHTML = notes
    .filter(note => note.content && note.content.trim() !== "") // ë‚´ìš©ì´ ìˆëŠ” ê²ƒë§Œ ê³¨ë¼ë‚´ê¸°
    .map(note => `
        <div class="note-item">
            <div class="time">${note.date}</div>
            <div class="text">${note.content.replace(/\n/g, '<br>')}</div>
            <button class="delete-btn" onclick="deleteNote(${note.id})">&times;</button>
        </div>
    `).join('');
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p style="text-align:center; color:red;">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }
// ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€ (êµ¬ê¸€ ì‹œíŠ¸ì™€ í†µì‹ )
    async function deleteNote(id) {
        if (!confirm("ì´ ë¶ˆí¸ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "delete", id: id })
            });
            displayNotes(); // ì‚­ì œ í›„ ëª©ë¡ ê°±ì‹ 
        } catch (e) {
            alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 3. ë°±ì—…ìš© íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    async function exportData() {
        try {
            const response = await fetch(API_URL);
            const notes = await response.json();
            const blob = new Blob([JSON.stringify(notes)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ë¶ˆí¸ì¼ê¸°_í†µí•©ë°±ì—…_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        } catch (e) {
            alert("ë°±ì—… ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>

</body>
</html>